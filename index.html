<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" >
<title>RV ASM</title>
<style>
#rvcanvas {
	width: 20%;

	border-width: 1px;
	border-style: solid;

	/* nearest neighbor scaling */
	image-rendering: -webkit-optimize-contrast; /* webkit */
	image-rendering: -moz-crisp-edges /* Firefox */
}

#rvserail {
	font-family: monospace;
}

#rvcode {
	font-family: monospace;
}
</style>
<script>
let rvscreen = {
	canvas: null,
	context: null,
	width: 0,
	height: 0,

	init: function init() {
		this.canvas = document.getElementById("rvcanvas");
		if (!this.canvas) {
			console.log("can't find canvas element");
			return;
		}

		this.context = this.canvas.getContext("2d");
		this.width = this.canvas.width;
		this.height = this.canvas.height;

		this.context.clearRect(0, 0, this.width, this.height);
	},

	newBuffer: function newBuffer() {
		return new Uint32Array(this.width * this.height);
	},

	set: function set(buffer) {
		let imgd = this.context.createImageData(this.width, this.height);
		for (let i=0; i<imgd.data.length; i+=4) {
			let pixel = buffer[i/4];
			imgd.data[i+0] = (pixel>>16) & 0xFF;
			imgd.data[i+1] = (pixel>> 8) & 0xFF;
			imgd.data[i+2] = (pixel>> 0) & 0xFF;
			imgd.data[i+3] = 0xFF;
		}
		this.context.putImageData(imgd, 0, 0);
	},
};

let rvserial = {
	output: {
		element: null,

		init: function init() {
			this.element = document.getElementById("rvserial_output");
			if (!this.element) {
				console.log("can't find rvserial textarea output element");
				return;
			}

			this.clear();
		},

		clear: function clear() {
			this.element.value = "";
		},

		put: function put(ch) {
			this.element.value += String.fromCharCode(ch);
		},
	},

	input: {
		inputElement: null,
		fifoElement: null,
		buffer: [],
		empty: true,

		init: function init() {
			this.inputElement = document.getElementById("rvserial_input");
			if (!this.inputElement) {
				console.log("can't find rvserial input element");
				return;
			}

			this.fifoElement = document.getElementById("rvserial_fifo");
			if (!this.fifoElement) {
				console.log("can't find rvserial FIFO element");
				return;
			}
			this.fifoElement.value = "";
		},

		put: function put(ch) {
			this.buffer.push(ch);

			this.empty = false;

			this.showFifo();
		},

		get: function get() {
			let ch = 0;

			if (this.buffer.length != 0) {
				let str = this.buffer.shift();
				ch = str.charCodeAt(0);

				if (this.buffer.length == 0) {
					this.empty = true;
				}
			}

			this.showFifo();

			return ch;
		},

		onsend: function onsend() {
			let str = this.inputElement.value;
			for (let i=0; i<str.length; i++) {
				this.put(str[i]);
			}

			this.inputElement.value = "";
		},

		showFifo: function showFifo() {
			let str = "";
			for (let i=0; i<this.buffer.length; i++) {
				str += this.buffer[i];
			}

			this.fifoElement.value = str;
		},
	},

	init: function init() {
		this.output.init();
		this.input.init();
	},
	
	put: function put(ch) {
		this.output.put(ch);
	},

	get: function get() {
		return this.input.get();
	},

	onsend: function onsend() {
		this.input.onsend();
	},
};

let rvcode = {
	element: null,

	init: function init() {
		this.element = document.getElementById("rvcode");
		if (!this.element) {
			console.log("can't find rvcode textarea element");
			return;
		}
	},

	get: function get() {
		return this.element.value;
	},
};

window.onload = function onload() {
	rvscreen.init();
	rvserial.init();

	rvserial.put(0x45);

	let buffer = rvscreen.newBuffer();
	buffer[0] = 0xFF00FF;
	rvscreen.set(buffer);
}
</script>
</head>
<body>
	<canvas id="rvcanvas" height="64" width="64"></canvas>

	<textarea id="rvserial_output" cols=40 rows=20 readonly></textarea>
	<textarea id="rvserial_fifo" cols=40 rows=1 readonly></textarea>
	<input type="text" id="rvserial_input" />
	<button id="rvserial_send" onclick="rvserial.onsend()">Send</button>

	<textarea id="rvcode" cols=40 rows=20 spellcheck="false"></textarea>

	<table>
		<tr> <td id="key0" /> <td id="value0" />
	</table>
</body>
</html>
